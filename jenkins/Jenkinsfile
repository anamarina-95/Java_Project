pipeline {
    agent { node { label 'worker1' } }
    
    tools {
        maven 'mvn3.9.9' 
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'checkout...'
                    git branch: 'main',
                    credentialsId: 'GH',
                    url: 'https://github.com/anamarina-95/Java_Project.git'
		    }
        }
        
        stage('Compile') {
            steps {
                echo 'compile...'
                    sh 'mvn compile'
		    }
        }
        
        stage('Codereview-Pmd') {
            steps {
                echo 'codereview...'
                    sh 'mvn -P metrics pmd:pmd'
		    }
		    post {
		        success {
		            recordIssues enabledForFailure: true, tool: pmdParser(pattern: '**/target/pmd.xml')
		        }
		    }		
        }
        
        stage('Unit-Test') {
            steps {
                echo 'unittest...'
                    sh 'mvn test'
                
            }
            post {
                success {
                    junit 'target/surefire-reports/*.xml'
                }
            }			
        }
        
        stage('CodeCoverage') {
            steps {
                echo 'unittest..'
                    sh 'mvn verify'
            }
            post {
                success {
                    jacoco buildOverBuild: true, deltaBranchCoverage: '20', deltaClassCoverage: '20', deltaComplexityCoverage: '20', deltaInstructionCoverage: '20', deltaLineCoverage: '20', deltaMethodCoverage: '20'
                }
            }			
        }
        
        stage('Build') {
            steps {
                echo 'package....'
                    sh 'mvn package'	
            }		
        }
        
        stage('Build Docker Image') {
	    steps {
		sh 'cp /root/jenkins/workspace/$JOB_NAME/target/ABCtechnologies-1.0.war /root/jenkins/workspace/$JOB_NAME/'
		sh 'docker build -t ABCtechnologies:$BUILD_NUMBER .'
		sh 'docker tag ABCtechnologies:$BUILD_NUMBER docker.io/anamarina95/ABCtechnologies:$BUILD_NUMBER'
	    }
	}

	stage('Push Docker Image') { 
	    steps {   
		withDockerRegistry([ credentialsId: "DHUB", url: "https://index.docker.io/v1/" ]) {
			sh 'docker push docker.io/anamarina95/ABCtechnologies:$BUILD_NUMBER'
		}
	    }
	}

	stage('Deploy as container') {
	    steps {
		sh 'docker run -itd -P anamarina95/ABCtechnologies:$BUILD_NUMBER'
	    }
	}   
    }
}